<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KraickList - Find Your Needs Here</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-gray-100 min-h-screen text-gray-800 overflow-x-hidden">
    <div class="max-w-4xl mx-auto p-4">
      <h1 class="text-3xl font-bold text-center mb-6">KraickList</h1>

      <form id="form" class="flex gap-2 mb-6" autocomplete="off">
        <input
          type="text"
          id="query"
          name="query"
          placeholder="Search anything..."
          class="flex-1 p-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"
        />
        <button
          type="submit"
          class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
        >
          Search
        </button>
      </form>
      <div id="highlightTags" class="flex flex-wrap gap-2 mb-6"></div>

      <div id="resultWrapper" class="space-y-4">
        <ul id="resultList" class="flex flex-wrap gap-4 justify-center"></ul>
      </div>
      <div id="pagination" class="mt-6 flex justify-center gap-2"></div>
    </div>

    <script>
      const form = document.getElementById("form");
      const resultList = document.getElementById("resultList");
      const highlightTags = document.getElementById("highlightTags");
      const pagination = document.getElementById("pagination");
      const PAGE_SIZE = 10; // Menambahkan limit dengan nilai 10

      const Controller = {
        init() {
          form.addEventListener("submit", Controller.search);
          Controller.loadHighlightTags();
          Controller.handleSearchFromURL();
          window.addEventListener("popstate", Controller.handleSearchFromURL);
        },

        search(ev) {
          ev.preventDefault();
          const data = Object.fromEntries(new FormData(form));
          if (data.query?.trim()) {
            history.pushState(
              null,
              "",
              `?q=${encodeURIComponent(data.query)}&page=0`
            );
          } else {
            history.pushState(null, "", `?page=0`);
          }
          Controller.fetchAndRender();
        },

        handleTagClick(tag) {
          const params = new URLSearchParams(location.search);
          const tags = params.getAll("tags[]");

          if (tags.includes(tag)) {
            // Jika tag sudah ada, hapus tag tersebut
            const tagIndex = tags.indexOf(tag);
            tags.splice(tagIndex, 1); // Menghapus tag dari array
            params.delete("tags[]"); // Menghapus semua tag yang ada sebelumnya
            tags.forEach((t) => params.append("tags[]", t)); // Menambahkan kembali tags yang tersisa
          } else {
            // Jika tag belum ada, tambahkan tag tersebut
            params.append("tags[]", tag);
          }

          params.delete("page");
          history.pushState(null, "", `?${params.toString()}`);
          Controller.fetchAndRender();
        },

        handleSearchFromURL() {
          Controller.fetchAndRender();
        },

        fetchAndRender() {
          const params = new URLSearchParams(location.search);
          const q = params.get("q");
          const tags = params.getAll("tags[]");
          const page = parseInt(params.get("page") || "0");

          const urlParams = new URLSearchParams();
          if (q) urlParams.set("q", q);
          if (tags.length > 0)
            tags.forEach((t) => urlParams.append("tags[]", t));
          urlParams.set("page", page.toString());
          urlParams.set("limit", PAGE_SIZE.toString()); // Menambahkan limit = 10

          fetch(`/api/product/search?${urlParams.toString()}`)
            .then((res) => res.json())
            .then((res) => {
              const { total, data } = res.data;
              if (!data || data.length === 0) {
                resultList.innerHTML = `<p class="text-center text-gray-500">No results found.</p>`;
                pagination.innerHTML = "";
                return;
              }
              Controller.updateList(data);
              Controller.updatePagination(total, page);
            });
        },

        updatePagination(total, currentPage) {
          const totalPages = Math.ceil(total / PAGE_SIZE);
          if (totalPages <= 1) {
            pagination.innerHTML = "";
            return;
          }

          const params = new URLSearchParams(location.search);
          const buttons = [];

          const createButton = (page, label = null, isActive = false) => {
            const newParams = new URLSearchParams(params);
            newParams.set("page", page.toString());
            return `
              <button onclick="history.pushState(null, '', '?${newParams.toString()}'); Controller.fetchAndRender();"
                class="px-3 py-1 rounded ${
                  isActive
                    ? "bg-blue-600 text-white"
                    : "bg-gray-200 text-gray-800 hover:bg-gray-300"
                }">
                ${label ?? page + 1}
              </button>
            `;
          };

          const createEllipsis = () =>
            `<span class="px-2 py-1 text-gray-500">...</span>`;

          if (totalPages <= 5) {
            for (let i = 0; i < totalPages; i++) {
              buttons.push(createButton(i, null, i === currentPage));
            }
          } else if (currentPage <= 2) {
            for (let i = 0; i < 4; i++) {
              buttons.push(createButton(i, null, i === currentPage));
            }
            buttons.push(createEllipsis());
            buttons.push(createButton(totalPages - 1));
          } else if (currentPage >= totalPages - 3) {
            buttons.push(createButton(0));
            buttons.push(createEllipsis());
            for (let i = totalPages - 4; i < totalPages; i++) {
              buttons.push(createButton(i, null, i === currentPage));
            }
          } else {
            buttons.push(createButton(0));
            buttons.push(createEllipsis());
            for (let i = currentPage - 1; i <= currentPage + 1; i++) {
              buttons.push(createButton(i, null, i === currentPage));
            }
            buttons.push(createEllipsis());
            buttons.push(createButton(totalPages - 1));
          }

          pagination.innerHTML = buttons.join(" ");
        },

        updateList(results) {
          const rows = results.map((result) => {
            return `
              <li class="bg-white p-4 rounded shadow-md flex flex-col w-full sm:w-[calc(50%-1rem)] md:w-[calc(33.333%-1rem)] max-w-sm">
                <img src="${
                  result.thumb_url
                }" alt="Thumbnail" class="w-full h-40 object-cover rounded mb-2" />
                <div class="flex-1 min-w-0">
                  <h2 class="text-lg font-semibold truncate">
                    <a href="/product?id=${
                      result.id
                    }" class="hover:underline">${result.title}</a>
                  </h2>
                  <p class="text-sm text-gray-600 mt-1 line-clamp-3">${
                    result.content
                  }</p>
                  <div class="mt-2 flex flex-wrap gap-1">
                    ${result.tags
                      .map(
                        (tag) => `
                        <span onclick="Controller.handleTagClick('${tag}')" 
                          class="cursor-pointer text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded hover:bg-blue-200">
                          #${tag}
                        </span>`
                      )
                      .join("")}
                  </div>
                </div>
              </li>
            `;
          });
          resultList.innerHTML = rows.join("");
        },

        loadHighlightTags() {
          fetch("/api/product/tags-random")
            .then((res) => res.json())
            .then((res) => {
              const tags = res.data || [];
              highlightTags.innerHTML = tags
                .map(
                  (tag) => `
                  <button onclick="Controller.handleTagClick('${tag}')" 
                    class="text-sm bg-green-100 text-green-800 px-2 py-1 rounded hover:bg-green-200 transition">
                    #${tag}
                  </button>`
                )
                .join(" ");
            });
        },
      };

      Controller.init();
    </script>
  </body>
</html>
